name: Scheduled Tests

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
  DESTINATION: "platform=iOS Simulator,name=iPhone Air,OS=26.1"

jobs:
  code-quality:
    name: Code Quality
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /usr/local/Cellar
          key: homebrew-v1

      - name: Cache Mint
        uses: actions/cache@v4
        with:
          path: ~/.mint
          key: mint-v1

      - name: Install Tools
        run: |
          brew install mint swiftformat swiftlint xcodegen || true
          mint bootstrap || true

      - name: SwiftFormat Check
        run: swiftformat --lint Pulse PulseTests --reporter github-actions-log

      - name: SwiftLint
        run: swiftlint lint --path Pulse --path PulseTests --reporter github-actions-logging

  build:
    name: Build
    runs-on: macos-15
    needs: code-quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/Pulse-*/SourcePackages
            .build
          key: spm-v1

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Generate Project
        run: xcodegen generate

      - name: Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project Pulse.xcodeproj \
            -scheme PulseDev \
            -destination "$DESTINATION" \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

  tests:
    name: Tests (${{ matrix.test-type }})
    runs-on: macos-15
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-type: Unit
            scheme: PulseTests
            result-bundle: UnitTestResults
          - test-type: UI
            scheme: PulseUITests
            result-bundle: UITestResults
          - test-type: Snapshot
            scheme: PulseSnapshotTests
            result-bundle: SnapshotTestResults

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/Pulse-*/SourcePackages
            .build
          key: spm-v1

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Generate Project
        run: xcodegen generate

      - name: Run ${{ matrix.test-type }} Tests
        run: |
          xcodebuild test \
            -project Pulse.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -destination "$DESTINATION" \
            -resultBundlePath ${{ matrix.result-bundle }}.xcresult \
            -retry-tests-on-failure \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.result-bundle }}
          path: ${{ matrix.result-bundle }}.xcresult
          retention-days: 5

  test-results:
    name: Test Results Summary
    runs-on: macos-15
    needs: tests
    if: always()
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: ./results
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "## Scheduled Test Results - $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test results are available in the artifacts section." >> $GITHUB_STEP_SUMMARY
