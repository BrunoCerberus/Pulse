name: Scheduled Tests

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Project
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    # Cache Homebrew packages
    # Note: Static version key (brew-v1) - increment manually when brew dependencies change
    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    # Cache SPM dependencies
    # Note: Using static version key (spm-v2) due to hashFiles() limitations in this CI environment
    # Manually increment version (v2 -> v3) when project.yml package dependencies change
    # IMPORTANT: Do NOT use broad restore-keys fallback - it can restore stale package versions
    # v2: Added firebase-ios-sdk and GoogleSignIn packages
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v2

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Debug Package Dependencies
      run: |
        echo "Checking package dependencies..."
        if [ -d "Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/" ]; then
          ls -la Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/
          echo "Package.resolved content:"
          cat Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved || echo "Package.resolved not found"
        else
          echo "Swift PM directory not found (this is normal for a fresh project generation)"
        fi

    - name: Resolve Package Dependencies
      run: |
        echo "Explicitly resolving Swift Package Manager dependencies..."
        xcodebuild -resolvePackageDependencies \
          -project Pulse.xcodeproj \
          -scheme PulseDev \
          -onlyUsePackageVersionsFromResolvedFile
        echo "Package dependencies resolved successfully"

    - name: Pre-boot simulator
      run: |
        echo "Pre-booting simulator..."
        xcrun simctl boot "iPhone Air" || echo "Simulator already booted or unavailable"

    - name: Build for testing (PulseDev)
      run: |
        echo "Building PulseDev scheme for testing..."
        xcodebuild build-for-testing \
          -project Pulse.xcodeproj \
          -scheme PulseDev \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData

    - name: Build for testing (PulseSnapshotTests)
      run: |
        echo "Building PulseSnapshotTests scheme for testing..."
        xcodebuild build-for-testing \
          -project Pulse.xcodeproj \
          -scheme PulseSnapshotTests \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scheduled-build-products
        path: ./DerivedData
        retention-days: 1

  tests:
    name: ${{ matrix.test-name }}
    runs-on: macos-26
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-target: PulseTests
            test-name: Unit Tests
            scheme: PulseDev
            artifact-name: scheduled-unit-test-results
            timeout: 60
          - test-target: PulseUITests
            test-name: UI Tests
            scheme: PulseDev
            artifact-name: scheduled-ui-test-results
            timeout: 60
          - test-target: PulseSnapshotTests
            test-name: Snapshot Tests
            scheme: PulseSnapshotTests
            artifact-name: scheduled-snapshot-test-results
            timeout: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    # Cache Homebrew packages
    # Note: Static version key (brew-v1) - increment manually when brew dependencies change
    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    # Cache SPM dependencies
    # Note: Using static version key (spm-v2) due to hashFiles() limitations in this CI environment
    # Manually increment version (v2 -> v3) when project.yml package dependencies change
    # IMPORTANT: Do NOT use broad restore-keys fallback - it can restore stale package versions
    # v2: Added firebase-ios-sdk and GoogleSignIn packages
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v2

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: scheduled-build-products
        path: ./DerivedData

    - name: Pre-boot simulator
      run: |
        echo "Pre-booting simulator..."
        xcrun simctl boot "iPhone Air" || echo "Simulator already booted or unavailable"

    - name: Run ${{ matrix.test-name }}
      timeout-minutes: ${{ matrix.timeout }}
      run: |
        mkdir -p test-results
        set -o pipefail

        xcodebuild test-without-building \
          -project Pulse.xcodeproj \
          -scheme ${{ matrix.scheme }} \
          -only-testing:${{ matrix.test-target }} \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData \
          -resultBundlePath test-results/${{ matrix.artifact-name }}.xcresult \
          -disableAutomaticPackageResolution \
          -retry-tests-on-failure \
          | tee /tmp/test_output.log
        TEST_EXIT_CODE=$?
        grep -E "(Test run.*passed|Test run.*failed)" /tmp/test_output.log | tail -5 || echo "${{ matrix.test-name }} completed"
        exit $TEST_EXIT_CODE

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ matrix.artifact-name }}
        path: test-results/${{ matrix.artifact-name }}.xcresult
        if-no-files-found: warn
        retention-days: 5

    - name: Upload recorded snapshots
      uses: actions/upload-artifact@v4
      if: always() && matrix.test-target == 'PulseSnapshotTests'
      with:
        name: scheduled-recorded-snapshots
        path: PulseSnapshotTests/**/__Snapshots__/**/*.png
        if-no-files-found: ignore

  test-results:
    name: Test Results Summary
    runs-on: macos-26
    needs: [tests]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download unit test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-unit-test-results
        path: unit-test-results

    - name: Download UI test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-ui-test-results
        path: ui-test-results

    - name: Download snapshot test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-snapshot-test-results
        path: snapshot-test-results

    - name: Check test job results
      id: check-results
      run: |
        # Check the outcome of the tests job
        TEST_RESULT="${{ needs.tests.result }}"
        echo "Tests job result: $TEST_RESULT"

        if [ "$TEST_RESULT" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: Display Test Results Summary
      run: |
        echo "Scheduled Test Results Summary"
        echo "==============================="
        echo ""

        # Check if artifacts exist and display status
        UNIT_STATUS="Unknown"
        UI_STATUS="Unknown"
        SNAPSHOT_STATUS="Unknown"

        if [ -d "unit-test-results" ]; then
          UNIT_STATUS="Completed"
        else
          UNIT_STATUS="Failed or Missing"
        fi

        if [ -d "ui-test-results" ]; then
          UI_STATUS="Completed"
        else
          UI_STATUS="Failed or Missing"
        fi

        if [ -d "snapshot-test-results" ]; then
          SNAPSHOT_STATUS="Completed"
        else
          SNAPSHOT_STATUS="Failed or Missing"
        fi

        echo "Unit Tests: $UNIT_STATUS"
        echo "UI Tests: $UI_STATUS"
        echo "Snapshot Tests: $SNAPSHOT_STATUS"
        echo ""
        echo "Test artifacts downloaded:"
        ls -la unit-test-results/ 2>/dev/null || echo "  No unit test artifacts found"
        ls -la ui-test-results/ 2>/dev/null || echo "  No UI test artifacts found"
        ls -la snapshot-test-results/ 2>/dev/null || echo "  No snapshot test artifacts found"
        echo ""

        if [ "${{ steps.check-results.outputs.status }}" == "success" ]; then
          echo "All scheduled tests completed successfully!"
        else
          echo "Some tests failed or were cancelled"
        fi
        echo ""
        echo "Daily test run completed at $(date)"

    - name: Fail if tests failed
      if: steps.check-results.outputs.status == 'failure'
      run: |
        echo "::error::Test suite failed or was cancelled"
        exit 1

  auto-fix-tests:
    name: Auto-Fix Failing Tests
    runs-on: macos-26
    needs: [test-results]
    if: always() && needs.test-results.result == 'failure'
    concurrency:
      group: auto-fix-tests
      cancel-in-progress: true
    permissions:
      actions: read
      contents: write
      pull-requests: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v2

    - name: Install dependencies
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Download unit test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-unit-test-results
        path: unit-test-results

    - name: Download UI test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-ui-test-results
        path: ui-test-results

    - name: Download snapshot test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: scheduled-snapshot-test-results
        path: snapshot-test-results

    - name: Extract test failure details
      id: extract-failures
      run: |
        echo "Extracting test failure information..."
        echo "======================================="

        # Check what test result directories exist
        echo "Available test result directories:"
        ls -la unit-test-results/ 2>/dev/null || echo "  unit-test-results: not found"
        ls -la ui-test-results/ 2>/dev/null || echo "  ui-test-results: not found"
        ls -la snapshot-test-results/ 2>/dev/null || echo "  snapshot-test-results: not found"
        echo ""

        # Extract failures from xcresult bundles using xcresulttool
        for result_dir in unit-test-results ui-test-results snapshot-test-results; do
          if [ -d "$result_dir" ]; then
            for xcresult in "$result_dir"/*.xcresult; do
              if [ -d "$xcresult" ]; then
                echo "Processing $xcresult..."

                # Method 1: Try to get test results summary first
                echo "  Attempting test-results extraction..."
                xcrun xcresulttool get test-results summary --path "$xcresult" 2>/dev/null | head -50 || echo "  test-results summary not available"

                # Method 2: Get failures using JSON query
                echo "  Attempting JSON extraction..."
                xcrun xcresulttool get --format json --path "$xcresult" 2>/dev/null | \
                  jq -r '.. | objects | select(.testStatus == "Failure") | "Test: \(.identifier // "unknown")\nName: \(.name // "unknown")\nMessage: \(.failureSummaries // [] | .[0]?.message // "No message")\nFile: \(.failureSummaries // [] | .[0]?.fileName // "Unknown") line \(.failureSummaries // [] | .[0]?.lineNumber // "?")\n---"' 2>/dev/null >> /tmp/failures.txt || true

                # Method 3: Alternative - look for issues in the result bundle
                echo "  Attempting issues extraction..."
                xcrun xcresulttool get --format json --path "$xcresult" 2>/dev/null | \
                  jq -r '.. | objects | select(.issueType? != null) | "Issue: \(.issueType // "unknown")\nMessage: \(.message // "No message")\nFile: \(.documentLocationInCreatingWorkspace?.url // "Unknown")\n---"' 2>/dev/null >> /tmp/failures.txt || true

                echo ""
              fi
            done
          fi
        done

        echo "======================================="
        echo "Extraction complete. Checking results..."
        echo ""

        if [ -f /tmp/failures.txt ] && [ -s /tmp/failures.txt ]; then
          echo "Found failures in /tmp/failures.txt:"
          echo "--------------------------------------"
          cat /tmp/failures.txt | head -100
          echo "--------------------------------------"
        else
          echo "WARNING: No failures extracted from xcresult bundles"
          echo "Creating fallback failure message..."
          echo "Test failures detected but details could not be extracted from xcresult bundles." > /tmp/failures.txt
          echo "Please check the workflow logs and xcresult artifacts for details." >> /tmp/failures.txt
        fi

        # Copy to the file Claude will read
        cp /tmp/failures.txt /tmp/test_failures.txt
        echo ""
        echo "Final content of /tmp/test_failures.txt:"
        echo "--------------------------------------"
        cat /tmp/test_failures.txt
        echo "--------------------------------------"
        echo "failures_found=true" >> $GITHUB_OUTPUT

    - name: Create fix branch
      id: create-branch
      env:
        RUN_ID: ${{ github.run_id }}
      run: |
        BRANCH_NAME="auto-fix/test-failures-${RUN_ID}"
        git checkout -b "$BRANCH_NAME"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Run Claude to analyze and fix tests
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        prompt: |
          You are analyzing failing tests in a scheduled CI run for the Pulse iOS app.

          ## Test Failure Details
          Read the file /tmp/test_failures.txt to see what tests failed.

          ## Your Task
          1. Read /tmp/test_failures.txt to see which tests failed
          2. Analyze the failing tests to understand what's broken
          3. Look at the relevant test files and source code
          4. Fix the issues causing test failures

          ## Guidelines
          - Focus only on fixing the failing tests, don't refactor unrelated code
          - If a test is flaky, consider adding retry logic or fixing the race condition
          - For snapshot test failures, regenerate snapshots if the UI change was intentional
          - For unit test failures, fix either the test or the source code depending on what's correct
          - If you cannot fix a test, document why in a comment

          ## After fixing
          - Stage all changes with git add
          - Do NOT commit - the workflow will handle that
        claude_args: '--dangerously-skip-permissions'

    - name: Check for changes
      id: check-changes
      run: |
        echo "======================================="
        echo "Checking for source code changes made by Claude..."
        echo "======================================="
        echo ""

        # Show all changes (for debugging)
        echo "All git status (including artifacts):"
        git status --short | head -50
        echo ""

        # Only check for changes in source code, not test result artifacts
        # Exclude test result directories from the check
        echo "Source code changes only (excluding test artifacts):"
        git status --short -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results'
        echo ""

        if git diff --quiet -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results' && \
           git diff --staged --quiet -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results'; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "RESULT: No source code changes made by Claude"
          echo ""
          echo "This could mean:"
          echo "  - Claude couldn't determine a fix for the failing tests"
          echo "  - The test failure info wasn't detailed enough"
          echo "  - The issue requires manual intervention"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "RESULT: Source code changes detected!"
          echo ""
          echo "Changed files:"
          git diff --name-only -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results'
          echo ""
          echo "Staged files:"
          git diff --staged --name-only -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results'
          echo ""
          echo "Diff preview (first 100 lines):"
          git diff -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results' | head -100
        fi
        echo "======================================="

    - name: Validate fixes (build project)
      id: validate-fixes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "Validating Claude's fixes by building the project..."
        xcodebuild build \
          -project Pulse.xcodeproj \
          -scheme PulseDev \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -quiet \
          CODE_SIGNING_ALLOWED=NO || {
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "::warning::Build failed after Claude's fixes - changes may be incomplete"
            exit 0
          }
        echo "build_failed=false" >> $GITHUB_OUTPUT
        echo "Build successful - fixes validated"

    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
        GH_REPO: ${{ github.repository }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Configure git to use the token for authentication
        git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GH_REPO}.git"

        # Only add source code changes, not test result artifacts
        git add -A -- ':!unit-test-results' ':!ui-test-results' ':!snapshot-test-results'
        git commit -m "fix: auto-fix failing tests from scheduled run

        This commit contains automated fixes for test failures detected
        in the scheduled nightly test run.

        Fixes generated by Claude Code CLI."

        git push --force-with-lease origin "$BRANCH_NAME"

    - name: Create Pull Request
      if: steps.check-changes.outputs.has_changes == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_SERVER_URL: ${{ github.server_url }}
        GH_REPOSITORY: ${{ github.repository }}
        GH_RUN_ID: ${{ github.run_id }}
        BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
      run: |
        gh pr create \
          --draft \
          --title "fix: Auto-fix test failures from $(date +%Y-%m-%d) scheduled run" \
          --body "## Automated Test Fix PR

        This PR was automatically generated by Claude Code in response to failing tests
        in the scheduled nightly test run.

        ### What happened
        - Scheduled tests ran and detected failures
        - Claude analyzed the test failures and attempted fixes
        - Build validation: ${{ steps.validate-fixes.outputs.build_failed == 'true' && 'FAILED' || 'PASSED' }}
        - This PR contains the proposed fixes

        ### Review checklist
        - [ ] Verify the fixes are correct and don't mask real bugs
        - [ ] Check that no unintended changes were made
        - [ ] Run tests locally to confirm fixes work

        ### Test failure details
        See the [workflow run](${GH_SERVER_URL}/${GH_REPOSITORY}/actions/runs/${GH_RUN_ID}) for full details.

        ---
        *This draft PR was auto-generated by the scheduled-tests workflow.*" \
          --base master \
          --head "$BRANCH_NAME"
