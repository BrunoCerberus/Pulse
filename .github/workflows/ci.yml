name: CI Pipeline

on:
  pull_request:
    branches: [develop, master, main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    # Cache Homebrew packages
    # Note: Static version key (brew-v1) - increment manually when brew dependencies change
    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    # Cache Mint packages
    # Note: Static version key (mint-v1) - increment manually when mint dependencies change
    - name: Cache Mint packages
      uses: actions/cache@v4
      with:
        path: ~/.mint
        key: ${{ runner.os }}-mint-v1
        restore-keys: |
          ${{ runner.os }}-mint-

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Install Mint
      run: |
        brew install mint

    - name: Install SwiftFormat via Mint
      run: |
        mint install nicklockwood/SwiftFormat

    - name: Install SwiftLint
      run: |
        brew install swiftlint

    - name: Validate SwiftFormat
      run: |
        echo "Running SwiftFormat validation..."
        if mint run swiftformat Pulse PulseTests --lint; then
          echo "SwiftFormat validation passed"
        else
          echo "SwiftFormat validation failed!"
          echo "Please run 'mint run swiftformat Pulse PulseTests' locally to fix formatting issues."
          exit 1
        fi

    - name: Run SwiftLint
      run: |
        echo "Running SwiftLint..."
        if swiftlint lint Pulse PulseTests --reporter github-actions-logging; then
          echo "SwiftLint validation passed"
        else
          echo "SwiftLint found issues!"
          echo "Please run 'swiftlint' locally to see detailed issues."
          exit 1
        fi

    - name: Check for TODO comments
      run: |
        echo "Checking for TODO comments..."
        if grep -r "TODO" --include="*.swift" Pulse PulseTests; then
          echo "TODO comments found in code"
        else
          echo "No TODO comments found"
        fi

    - name: Check for FIXME comments
      run: |
        echo "Checking for FIXME comments..."
        if grep -r "FIXME" --include="*.swift" Pulse PulseTests; then
          echo "FIXME comments found in code"
        else
          echo "No FIXME comments found"
        fi

  build:
    name: Build Project
    runs-on: macos-26
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    # Cache Homebrew packages
    # Note: Static version key (brew-v1) - increment manually when brew dependencies change
    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    # Cache SPM dependencies
    # Note: Using static version key (spm-v3) due to hashFiles() limitations in this CI environment
    # Manually increment version (v3 -> v4) when project.yml package dependencies change
    # IMPORTANT: Do NOT use broad restore-keys fallback - it can restore stale package versions
    # v3: Updated EntropyCore revision (migrated UDF protocols)
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v3

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Debug Package Dependencies
      run: |
        echo "Checking package dependencies..."
        if [ -d "Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/" ]; then
          ls -la Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/
          echo "Package.resolved content:"
          cat Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved || echo "Package.resolved not found"
        else
          echo "Swift PM directory not found (this is normal for a fresh project generation)"
        fi

    - name: Resolve Package Dependencies
      run: |
        echo "Explicitly resolving Swift Package Manager dependencies..."
        xcodebuild -resolvePackageDependencies \
          -project Pulse.xcodeproj \
          -scheme PulseDev \
          -onlyUsePackageVersionsFromResolvedFile
        echo "Package dependencies resolved successfully"

    - name: Pre-boot simulator
      run: |
        echo "Pre-booting simulator..."
        xcrun simctl boot "iPhone Air" || echo "Simulator already booted or unavailable"

    - name: Build for testing (PulseDev)
      run: |
        echo "Building PulseDev scheme for testing..."
        xcodebuild build-for-testing \
          -project Pulse.xcodeproj \
          -scheme PulseDev \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData \
          ENABLE_ONLY_ACTIVE_RESOURCES=NO

    - name: Build for testing (PulseSnapshotTests)
      run: |
        echo "Building PulseSnapshotTests scheme for testing..."
        xcodebuild build-for-testing \
          -project Pulse.xcodeproj \
          -scheme PulseSnapshotTests \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData \
          ENABLE_ONLY_ACTIVE_RESOURCES=NO

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-products
        path: ./DerivedData
        retention-days: 1

  tests:
    name: ${{ matrix.test-name }}
    runs-on: macos-26
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-target: PulseTests
            test-name: Unit Tests
            scheme: PulseDev
            artifact-name: unit-test-results
            timeout: 60
          - test-target: PulseUITests
            test-name: UI Tests
            scheme: PulseDev
            artifact-name: ui-test-results
            timeout: 60
          - test-target: PulseSnapshotTests
            test-name: Snapshot Tests
            scheme: PulseSnapshotTests
            artifact-name: snapshot-test-results
            timeout: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1
      with:
        xcode-version: '26.2'

    # Cache Homebrew packages
    # Note: Static version key (brew-v1) - increment manually when brew dependencies change
    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    # Cache SPM dependencies
    # Note: Using static version key (spm-v3) due to hashFiles() limitations in this CI environment
    # Manually increment version (v3 -> v4) when project.yml package dependencies change
    # IMPORTANT: Do NOT use broad restore-keys fallback - it can restore stale package versions
    # v3: Updated EntropyCore revision (migrated UDF protocols)
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v3

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-products
        path: ./DerivedData

    - name: Pre-boot simulator
      run: |
        echo "Pre-booting simulator..."
        xcrun simctl boot "iPhone Air" || echo "Simulator already booted or unavailable"

    - name: Run ${{ matrix.test-name }}
      timeout-minutes: ${{ matrix.timeout }}
      run: |
        mkdir -p test-results
        set -o pipefail

        xcodebuild test-without-building \
          -project Pulse.xcodeproj \
          -scheme ${{ matrix.scheme }} \
          -only-testing:${{ matrix.test-target }} \
          -destination 'platform=iOS Simulator,name=iPhone Air,OS=26.2' \
          -derivedDataPath ./DerivedData \
          -resultBundlePath test-results/${{ matrix.artifact-name }}.xcresult \
          -disableAutomaticPackageResolution \
          -retry-tests-on-failure \
          2>&1 | tee /tmp/test_output.log

        TEST_EXIT_CODE=${PIPESTATUS[0]}

        echo ""
        echo "============================================"
        echo "              TEST SUMMARY"
        echo "============================================"
        grep -E "(Test Suite.*started|Test Suite.*passed|Test Suite.*failed|Executed [0-9]+ test)" /tmp/test_output.log | tail -10 || echo "${{ matrix.test-name }} completed"

        exit $TEST_EXIT_CODE

    - name: Extract and display test failures
      if: failure()
      run: |
        RESULT_BUNDLE="test-results/${{ matrix.artifact-name }}.xcresult"

        echo ""
        echo "============================================"
        echo "          FAILED TESTS SUMMARY"
        echo "============================================"
        echo ""

        # Check if xcresult exists
        if [ ! -d "$RESULT_BUNDLE" ]; then
          echo "::warning::Test result bundle not found at $RESULT_BUNDLE"
          echo "Falling back to log parsing..."
          echo ""
          grep -E "(✘|Test Case.*failed|FAIL|Assertion)" /tmp/test_output.log 2>/dev/null | head -50 || echo "No failures found in log"
          exit 0
        fi

        # Write header to job summary
        echo "## ❌ ${{ matrix.test-name }} Failures" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Extract test failures using xcresulttool (requires --legacy flag on newer Xcode)
        python3 << 'PYTHON_SCRIPT'
        import json
        import subprocess
        import sys
        import os

        result_bundle = os.environ.get('RESULT_BUNDLE', 'test-results/test.xcresult')
        summary_file = os.environ.get('GITHUB_STEP_SUMMARY', '/dev/null')

        # Try new format first, then legacy
        data = None
        for legacy_flag in ["", "--legacy"]:
            try:
                cmd = ["xcrun", "xcresulttool", "get", "object"]
                if legacy_flag:
                    cmd.append(legacy_flag)
                cmd.extend(["--path", result_bundle, "--format", "json"])

                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0 and result.stdout.strip():
                    data = json.loads(result.stdout)
                    break
            except Exception:
                continue

        if data is None:
            print("Could not parse xcresult bundle")
            sys.exit(0)

        # Navigate to test failure summaries
        actions = data.get('actions', {}).get('_values', [])
        if not actions:
            print("No actions found in xcresult")
            sys.exit(0)

        action = actions[0]
        issues = action.get('actionResult', {}).get('issues', {})
        failures = issues.get('testFailureSummaries', {}).get('_values', [])

        if not failures:
            print("No test failures found in xcresult (test may have crashed)")
            sys.exit(0)

        print(f"Found {len(failures)} test failure(s):")
        print("")

        # Also write to GITHUB_STEP_SUMMARY
        with open(summary_file, "a") as summary:
            summary.write("| Test | Failure Message |\n")
            summary.write("|------|----------------|\n")

            for f in failures:
                test_name = f.get('testCaseName', {}).get('_value', 'Unknown Test')
                message = f.get('message', {}).get('_value', 'No message')

                # Clean up message for display
                message_short = message[:150] + "..." if len(message) > 150 else message
                message_escaped = message_short.replace("|", "\\|").replace("\n", " ")

                # Print to console
                print(f"❌ {test_name}")
                print(f"   {message_short}")
                print("")

                # GitHub Actions error annotation
                print(f"::error title={test_name}::{message_short}")

                # Write to summary
                summary.write(f"| `{test_name}` | {message_escaped} |\n")

        print("")
        print("See the uploaded .xcresult artifact for full details.")
        PYTHON_SCRIPT
      env:
        RESULT_BUNDLE: test-results/${{ matrix.artifact-name }}.xcresult

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ matrix.artifact-name }}
        path: test-results/${{ matrix.artifact-name }}.xcresult
        if-no-files-found: warn

    - name: Upload recorded snapshots
      uses: actions/upload-artifact@v4
      if: always() && matrix.test-target == 'PulseSnapshotTests'
      with:
        name: recorded-snapshots
        path: PulseSnapshotTests/**/__Snapshots__/**/*.png
        if-no-files-found: ignore

  test-results:
    name: Test Results Summary
    runs-on: macos-26
    needs: [tests]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download unit test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: unit-test-results
        path: unit-test-results

    - name: Download UI test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: ui-test-results
        path: ui-test-results

    - name: Download snapshot test results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: snapshot-test-results
        path: snapshot-test-results

    - name: Check test job results
      id: check-results
      run: |
        # Check the outcome of the tests job
        TEST_RESULT="${{ needs.tests.result }}"
        echo "Tests job result: $TEST_RESULT"

        if [ "$TEST_RESULT" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: Display Test Results Summary
      run: |
        echo "Test Results Summary"
        echo "===================="
        echo ""

        # Check if artifacts exist and display status
        UNIT_STATUS="Unknown"
        UI_STATUS="Unknown"
        SNAPSHOT_STATUS="Unknown"

        if [ -d "unit-test-results" ]; then
          UNIT_STATUS="Completed"
        else
          UNIT_STATUS="Failed or Missing"
        fi

        if [ -d "ui-test-results" ]; then
          UI_STATUS="Completed"
        else
          UI_STATUS="Failed or Missing"
        fi

        if [ -d "snapshot-test-results" ]; then
          SNAPSHOT_STATUS="Completed"
        else
          SNAPSHOT_STATUS="Failed or Missing"
        fi

        echo "Unit Tests: $UNIT_STATUS"
        echo "UI Tests: $UI_STATUS"
        echo "Snapshot Tests: $SNAPSHOT_STATUS"
        echo ""
        echo "Test artifacts downloaded:"
        ls -la unit-test-results/ 2>/dev/null || echo "  No unit test artifacts found"
        ls -la ui-test-results/ 2>/dev/null || echo "  No UI test artifacts found"
        ls -la snapshot-test-results/ 2>/dev/null || echo "  No snapshot test artifacts found"
        echo ""

        if [ "${{ steps.check-results.outputs.status }}" == "success" ]; then
          echo "All tests completed successfully!"
        else
          echo "Some tests failed or were cancelled"
        fi

    - name: Fail if tests failed
      if: steps.check-results.outputs.status == 'failure'
      run: |
        echo "::error::Test suite failed or was cancelled"
        exit 1
