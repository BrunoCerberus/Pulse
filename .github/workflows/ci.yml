name: CI

on:
  pull_request:
    branches: [develop, master, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
  SCHEME_DEV: PulseDev
  SCHEME_SNAPSHOT: PulseSnapshotTests
  DESTINATION: "platform=iOS Simulator,name=iPhone Air,OS=26.1"

jobs:
  code-quality:
    name: Code Quality
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /usr/local/Cellar
          key: homebrew-v1

      - name: Cache Mint
        uses: actions/cache@v4
        with:
          path: ~/.mint
          key: mint-v1

      - name: Install Tools
        run: |
          brew install mint swiftformat swiftlint xcodegen || true
          mint bootstrap || true

      - name: SwiftFormat Check
        run: swiftformat --lint Pulse PulseTests --reporter github-actions-log

      - name: SwiftLint
        run: swiftlint lint --path Pulse --path PulseTests --reporter github-actions-logging

      - name: TODO/FIXME Check
        run: |
          echo "Checking for TODO and FIXME comments..."
          TODOS=$(grep -rn "TODO\|FIXME" Pulse --include="*.swift" || true)
          if [ -n "$TODOS" ]; then
            echo "::warning::Found TODO/FIXME comments:"
            echo "$TODOS"
          fi

  build:
    name: Build
    runs-on: macos-15
    needs: code-quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/Pulse-*/SourcePackages
            .build
          key: spm-v1

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Generate Project
        run: xcodegen generate

      - name: Build for Testing (Dev)
        run: |
          xcodebuild build-for-testing \
            -project Pulse.xcodeproj \
            -scheme $SCHEME_DEV \
            -destination "$DESTINATION" \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Build for Testing (Snapshots)
        run: |
          xcodebuild build-for-testing \
            -project Pulse.xcodeproj \
            -scheme $SCHEME_SNAPSHOT \
            -destination "$DESTINATION" \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

  tests:
    name: Tests (${{ matrix.test-type }})
    runs-on: macos-15
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-type: Unit
            scheme: PulseTests
            result-bundle: UnitTestResults
          - test-type: UI
            scheme: PulseUITests
            result-bundle: UITestResults
          - test-type: Snapshot
            scheme: PulseSnapshotTests
            result-bundle: SnapshotTestResults

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/Pulse-*/SourcePackages
            .build
          key: spm-v1

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Generate Project
        run: xcodegen generate

      - name: Run ${{ matrix.test-type }} Tests
        run: |
          xcodebuild test \
            -project Pulse.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -destination "$DESTINATION" \
            -resultBundlePath ${{ matrix.result-bundle }}.xcresult \
            -retry-tests-on-failure \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.result-bundle }}
          path: ${{ matrix.result-bundle }}.xcresult
          retention-days: 7

  test-results:
    name: Test Results Summary
    runs-on: macos-15
    needs: tests
    if: always()
    steps:
      - name: Download Unit Test Results
        uses: actions/download-artifact@v4
        with:
          name: UnitTestResults
          path: ./results/unit
        continue-on-error: true

      - name: Download UI Test Results
        uses: actions/download-artifact@v4
        with:
          name: UITestResults
          path: ./results/ui
        continue-on-error: true

      - name: Download Snapshot Test Results
        uses: actions/download-artifact@v4
        with:
          name: SnapshotTestResults
          path: ./results/snapshot
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for type in unit ui snapshot; do
            if [ -d "./results/$type" ]; then
              echo "### ${type^} Tests" >> $GITHUB_STEP_SUMMARY
              echo "Results available in artifacts" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
