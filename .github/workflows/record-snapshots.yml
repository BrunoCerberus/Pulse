name: Record Snapshots

on:
  workflow_dispatch: # Manual trigger only

jobs:
  record-snapshots:
    name: Record Snapshot References
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.0.1'

    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Homebrew
        key: ${{ runner.os }}-brew-v1
        restore-keys: |
          ${{ runner.os }}-brew-

    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          Pulse.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
        key: ${{ runner.os }}-spm-v1

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Generate Xcode project
      run: |
        make generate

    - name: Resolve Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project Pulse.xcodeproj \
          -scheme PulseSnapshotTests \
          -onlyUsePackageVersionsFromResolvedFile

    - name: Pre-boot simulator
      run: |
        xcrun simctl boot "iPhone Air" || echo "Simulator already booted"

    - name: Enable snapshot recording mode
      run: |
        # Set all snapshot tests to record mode
        find PulseSnapshotTests -name "*.swift" -exec sed -i '' 's/record: false/record: true/g' {} \;
        echo "Snapshot recording mode enabled"
        grep -r "record: true" PulseSnapshotTests/ || echo "No matches found"

    - name: Build and run snapshot tests (recording)
      run: |
        xcodebuild test \
          -project Pulse.xcodeproj \
          -scheme PulseSnapshotTests \
          -destination 'platform=iOS Simulator,name=iPhone Air' \
          -derivedDataPath ./DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          || echo "Tests completed (failures expected in record mode)"

    - name: Collect recorded snapshots
      run: |
        echo "Collecting recorded snapshot images..."
        mkdir -p recorded-snapshots
        find PulseSnapshotTests -path "*__Snapshots__*" -name "*.png" -exec cp {} recorded-snapshots/ \;
        ls -la recorded-snapshots/

    - name: Upload recorded snapshots
      uses: actions/upload-artifact@v4
      with:
        name: recorded-snapshots
        path: recorded-snapshots/
        retention-days: 30
        if-no-files-found: error

    - name: Upload full snapshot directories
      uses: actions/upload-artifact@v4
      with:
        name: snapshot-directories
        path: PulseSnapshotTests/**/__Snapshots__/
        retention-days: 30
        if-no-files-found: warn
